<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœåŠ¡æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-item {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .test-item.error {
            border-left-color: #f44336;
        }
        .test-item.warning {
            border-left-color: #ff9800;
        }
        pre {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ æœåŠ¡æµ‹è¯•é¡µé¢</h1>
    
    <div id="test-results"></div>
    
    <button onclick="runTests()">ğŸ§ª è¿è¡Œæµ‹è¯•</button>
    <button onclick="testUpload()">ğŸ“¤ æµ‹è¯•ä¸Šä¼ æœåŠ¡</button>
    <button onclick="testASR()">ğŸ¤ æµ‹è¯•ASRæœåŠ¡</button>

    <!-- å¼•å…¥æ‰€æœ‰æœåŠ¡ -->
    <script src="js/config.js?v=6"></script>
    <script src="js/asr-service.js?v=6"></script>
    <script src="js/simple-upload.js?v=6"></script>
    <script src="js/api.js?v=6"></script>

    <script>
        function addTestResult(name, status, details) {
            const resultsDiv = document.getElementById('test-results');
            const testItem = document.createElement('div');
            testItem.className = `test-item ${status}`;
            
            testItem.innerHTML = `
                <h3>${status === 'success' ? 'âœ…' : status === 'error' ? 'âŒ' : 'âš ï¸'} ${name}</h3>
                <pre>${JSON.stringify(details, null, 2)}</pre>
            `;
            
            resultsDiv.appendChild(testItem);
        }

        function runTests() {
            document.getElementById('test-results').innerHTML = '';
            
            // æµ‹è¯•1: æ£€æŸ¥å…¨å±€å¯¹è±¡
            try {
                const globals = {
                    ASRService: typeof window.ASRService,
                    SimpleUploadService: typeof window.SimpleUploadService,
                    configManager: typeof window.configManager,
                    apiService: typeof window.apiService
                };
                addTestResult('å…¨å±€å¯¹è±¡æ£€æŸ¥', 'success', globals);
            } catch (error) {
                addTestResult('å…¨å±€å¯¹è±¡æ£€æŸ¥', 'error', error.message);
            }

            // æµ‹è¯•2: æ£€æŸ¥APIæœåŠ¡çŠ¶æ€
            try {
                if (window.apiService) {
                    const apiStatus = {
                        mockMode: window.apiService.mockMode,
                        hasASRService: !!window.apiService.asrService,
                        hasUploadService: !!window.apiService.uploadService,
                        dashscopeConfig: window.apiService.config.dashscope.apiKey !== 'YOUR_DASHSCOPE_API_KEY'
                    };
                    addTestResult('APIæœåŠ¡çŠ¶æ€', 'success', apiStatus);
                } else {
                    addTestResult('APIæœåŠ¡çŠ¶æ€', 'error', 'apiServiceæœªåˆå§‹åŒ–');
                }
            } catch (error) {
                addTestResult('APIæœåŠ¡çŠ¶æ€', 'error', error.message);
            }

            // æµ‹è¯•3: æ£€æŸ¥é…ç½®ç®¡ç†å™¨
            try {
                if (window.configManager) {
                    const configStatus = {
                        isConfigured: window.configManager.isConfigured(),
                        dashscopeKey: !!window.configManager.getDashScopeApiKey()
                    };
                    addTestResult('é…ç½®ç®¡ç†å™¨', 'success', configStatus);
                } else {
                    addTestResult('é…ç½®ç®¡ç†å™¨', 'error', 'configManageræœªåˆå§‹åŒ–');
                }
            } catch (error) {
                addTestResult('é…ç½®ç®¡ç†å™¨', 'error', error.message);
            }

            // æµ‹è¯•4: æ£€æŸ¥ä¸Šä¼ æœåŠ¡
            try {
                if (window.apiService && window.apiService.uploadService) {
                    // ç¡®ä¿æœåŠ¡å·²åˆå§‹åŒ–
                    window.apiService.ensureServicesInitialized();

                    if (typeof window.apiService.uploadService.getStatus === 'function') {
                        const uploadStatus = window.apiService.uploadService.getStatus();
                        addTestResult('ä¸Šä¼ æœåŠ¡çŠ¶æ€', 'success', uploadStatus);
                    } else {
                        addTestResult('ä¸Šä¼ æœåŠ¡çŠ¶æ€', 'error', 'getStatusæ–¹æ³•ä¸å­˜åœ¨');
                    }
                } else {
                    addTestResult('ä¸Šä¼ æœåŠ¡çŠ¶æ€', 'warning', 'ä¸Šä¼ æœåŠ¡æœªåˆå§‹åŒ–');
                }
            } catch (error) {
                addTestResult('ä¸Šä¼ æœåŠ¡çŠ¶æ€', 'error', error.message);
            }
        }

        async function testUpload() {
            try {
                // ç¡®ä¿æœåŠ¡å·²åˆå§‹åŒ–
                if (window.apiService) {
                    window.apiService.ensureServicesInitialized();
                }

                // åˆ›å»ºä¸€ä¸ªå°çš„æµ‹è¯•éŸ³é¢‘æ–‡ä»¶
                const testBlob = new Blob(['test audio data'], { type: 'audio/wav' });

                if (window.apiService && window.apiService.uploadService) {
                    addTestResult('ä¸Šä¼ æµ‹è¯•', 'warning', 'å¼€å§‹æµ‹è¯•ä¸Šä¼ ...');

                    const url = await window.apiService.uploadService.uploadAudio(testBlob);
                    addTestResult('ä¸Šä¼ æµ‹è¯•', 'success', { url: url });
                } else {
                    addTestResult('ä¸Šä¼ æµ‹è¯•', 'error', 'ä¸Šä¼ æœåŠ¡æœªåˆå§‹åŒ–');
                }
            } catch (error) {
                addTestResult('ä¸Šä¼ æµ‹è¯•', 'error', error.message);
            }
        }

        async function testASR() {
            try {
                if (!window.configManager.isConfigured()) {
                    addTestResult('ASRæµ‹è¯•', 'warning', 'è¯·å…ˆé…ç½®DashScope API Key');
                    return;
                }

                // åˆ›å»ºä¸€ä¸ªå°çš„æµ‹è¯•éŸ³é¢‘æ–‡ä»¶
                const testBlob = new Blob(['test audio data'], { type: 'audio/wav' });
                
                addTestResult('ASRæµ‹è¯•', 'warning', 'å¼€å§‹æµ‹è¯•ASR...');
                
                const result = await window.apiService.transcribeAudio(testBlob);
                addTestResult('ASRæµ‹è¯•', 'success', result);
                
            } catch (error) {
                addTestResult('ASRæµ‹è¯•', 'error', error.message);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(runTests, 1000); // ç­‰å¾…1ç§’ç¡®ä¿æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ
        });
    </script>
</body>
</html>
